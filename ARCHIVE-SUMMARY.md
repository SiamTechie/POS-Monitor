# 📊 ระบบ Auto Archive - สรุปการทำงาน

## 🎯 ภาพรวม

ระบบจะแบ่งข้อมูลออกเป็น 2 ส่วนอัตโนมัติ:

```
┌─────────────────────────────────────────────────────┐
│  WordPress Clients (สาขาต่างๆ)                     │
│  ส่งข้อมูลทุก 15 นาที                               │
└────────────────┬────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────┐
│  Apps Script (doPost)                               │
│  รับข้อมูลและบันทึกลง Sheet "Current"              │
└────────────────┬────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────┐
│  Google Sheets                                      │
│  ┌──────────────────┐  ┌──────────────────┐        │
│  │  Current Sheet   │  │  Archive Sheet   │        │
│  │  (30 วันล่าสุด)  │  │  (ข้อมูลทั้งหมด) │        │
│  │  ~4,800 แถว     │  │  ไม่จำกัด        │        │
│  └──────────────────┘  └──────────────────┘        │
└────────────────┬────────────────────────────────────┘
                 │
                 ├─────────────────────────────────────┐
                 │                                     │
                 ▼                                     ▼
┌─────────────────────────────┐  ┌──────────────────────────────┐
│  Dashboard (doGet)          │  │  Auto Archive (ทุกวัน 02:00) │
│  ดึงข้อมูลจาก Current       │  │  ย้ายข้อมูลเก่า → Archive    │
│  แสดงสถานะ Real-time        │  │  ส่ง Email รายงาน            │
└─────────────────────────────┘  └──────────────────────────────┘
```

---

## 📋 เปรียบเทียบระบบ

| คุณสมบัติ | ระบบเดิม | ระบบ Auto Archive |
|-----------|----------|-------------------|
| **การเก็บข้อมูล** | Sheet เดียว | 2 Sheets (Current + Archive) |
| **ความเร็ว Dashboard** | ช้าลงเมื่อข้อมูลเยอะ | เร็วเสมอ (ดึงแค่ 30 วัน) |
| **ข้อมูลย้อนหลัง** | ดูได้ทั้งหมด แต่ช้า | ดูได้ทั้งหมดใน Archive |
| **การจัดการ** | ต้องลบข้อมูลเองเมื่อเต็ม | อัตโนมัติ 100% |
| **รายงาน** | ไม่มี | Email ทุกวัน |
| **ความจุ** | ~5-6 ปี | ไม่จำกัด (แบ่ง Sheet) |

---

## 🔄 กระบวนการ Auto Archive

### ทุกวันเวลา 02:00 น.

```
1. คำนวณวันตัดรอบ
   ├─ วันนี้: 24/12/2024
   └─ วันตัดรอบ: 24/11/2024 (30 วันที่แล้ว)

2. แยกข้อมูล
   ├─ ข้อมูลก่อน 24/11/2024 → ย้ายไป Archive
   └─ ข้อมูลหลัง 24/11/2024 → เก็บไว้ใน Current

3. ย้ายข้อมูล
   ├─ คัดลอกข้อมูลเก่าไป Archive
   ├─ ลบข้อมูลเก่าออกจาก Current
   └─ เก็บแค่ข้อมูล 30 วันล่าสุดใน Current

4. ส่งรายงาน Email
   ├─ จำนวนแถวที่ย้าย
   ├─ จำนวนแถวที่เหลือ
   └─ เวลาที่ทำงาน
```

---

## 📊 ตัวอย่างข้อมูล

### Current Sheet (30 วันล่าสุด)

| Timestamp | Branch Name | Avg Latency | Max Latency | Samples |
|-----------|-------------|-------------|-------------|---------|
| 24/12/2024 16:45 | สาขาสีลม | 85 | 120 | 15 |
| 24/12/2024 16:30 | สาขาสยาม | 120 | 180 | 15 |
| 24/12/2024 16:15 | สาขาอโศก | 95 | 140 | 15 |
| ... | ... | ... | ... | ... |
| 25/11/2024 00:00 | สาขาเมกา | 110 | 160 | 15 |

**จำนวน**: ~4,800 แถว (50 สาขา × 96 ครั้ง/วัน × 30 วัน)

---

### Archive Sheet (ข้อมูลทั้งหมด)

| Timestamp | Branch Name | Avg Latency | Max Latency | Samples |
|-----------|-------------|-------------|-------------|---------|
| 01/01/2024 00:00 | สาขาสีลม | 90 | 130 | 15 |
| 01/01/2024 00:15 | สาขาสยาม | 105 | 150 | 15 |
| ... | ... | ... | ... | ... |
| 24/11/2024 23:45 | สาขาเทอมินอล | 115 | 170 | 15 |

**จำนวน**: ไม่จำกัด (เก็บตั้งแต่เริ่มใช้งาน)

---

## 🎯 ประโยชน์

### 1. **Dashboard โหลดเร็ว**
- ดึงข้อมูลแค่ 4,800 แถว (30 วัน)
- แทนที่จะดึง 1,752,000 แถว (1 ปี)
- **เร็วขึ้น 365 เท่า!**

### 2. **ไม่ต้องกังวลเรื่องข้อมูลเต็ม**
- ข้อมูลเก่าถูกย้ายอัตโนมัติ
- Current Sheet ไม่เกิน 4,800 แถว
- Archive Sheet เก็บได้ไม่จำกัด

### 3. **ดูประวัติย้อนหลังได้ทั้งหมด**
- ข้อมูลไม่หายไปไหน
- เก็บไว้ใน Archive Sheet
- ค้นหาและวิเคราะห์ได้ตลอดเวลา

### 4. **รายงานอัตโนมัติ**
- รู้ว่าระบบทำงานปกติ
- ติดตามจำนวนข้อมูล
- แจ้งเตือนถ้ามีปัญหา

---

## 📧 ตัวอย่าง Email รายงาน

```
จาก: noreply@google.com
ถึง: your-email@company.com
เรื่อง: 📊 POS Monitor: Daily Archive Report

Auto-archive completed successfully!

📅 Cutoff Date: 24/11/2024 02:00:00
🗄️ Rows Archived: 4,800
📊 Rows Kept (Current): 2,880
⏰ Time: 24/12/2024 02:00:15

All data older than 30 days has been moved to the Archive sheet.
```

---

## 🔧 ฟังก์ชันที่มีให้

### ฟังก์ชันหลัก

| ฟังก์ชัน | คำอธิบาย | เรียกใช้ |
|---------|----------|---------|
| `setupSheets()` | สร้าง Sheets ครั้งแรก | รันครั้งเดียวตอนติดตั้ง |
| `doPost()` | รับข้อมูลจาก WordPress | อัตโนมัติ |
| `doGet()` | ส่งข้อมูลไปยัง Dashboard | อัตโนมัติ |
| `autoArchive()` | ย้ายข้อมูลเก่า | อัตโนมัติทุกวัน 02:00 |
| `createDailyTrigger()` | ตั้งค่า Auto-run | รันครั้งเดียวตอนติดตั้ง |

### ฟังก์ชันเสริม

| ฟังก์ชัน | คำอธิบาย |
|---------|----------|
| `getArchiveStats()` | ดูสถิติข้อมูล |
| `archiveByDateRange()` | Archive ช่วงเวลาที่กำหนด |
| `deleteAllTriggers()` | ลบ Trigger ทั้งหมด |
| `testDoPost()` | ทดสอบรับข้อมูล |
| `testDoGet()` | ทดสอบส่งข้อมูล |
| `testArchive()` | ทดสอบ Archive |

---

## 📈 ประมาณการข้อมูล (50 สาขา)

### ข้อมูลต่อวัน
- 50 สาขา × 96 ครั้ง/วัน = **4,800 แถว/วัน**

### Current Sheet (30 วัน)
- 4,800 × 30 = **144,000 แถว**
- ขนาดไฟล์: ~20 MB
- เวลาโหลด Dashboard: **< 2 วินาที**

### Archive Sheet (1 ปี)
- 4,800 × 365 = **1,752,000 แถว**
- ขนาดไฟล์: ~250 MB
- ใช้พื้นที่: 17.5% ของ Google Sheets

### Archive Sheet (5 ปี)
- 4,800 × 1,825 = **8,760,000 แถว**
- ขนาดไฟล์: ~1.2 GB
- ใช้พื้นที่: 87.6% ของ Google Sheets

---

## ⚙️ การตั้งค่าที่แนะนำ

### สำหรับสาขาน้อย (< 50 สาขา)
```javascript
ARCHIVE_AFTER_DAYS: 30  // เก็บ 30 วันใน Current
```

### สำหรับสาขาปานกลาง (50-100 สาขา)
```javascript
ARCHIVE_AFTER_DAYS: 30  // เก็บ 30 วันใน Current
```

### สำหรับสาขาเยอะ (> 100 สาขา)
```javascript
ARCHIVE_AFTER_DAYS: 14  // เก็บ 14 วันใน Current (เร็วขึ้น)
```

---

## 🎓 Best Practices

### 1. **ตรวจสอบ Email รายงานทุกวัน**
- ดูว่าระบบทำงานปกติ
- ติดตามจำนวนข้อมูล

### 2. **Export Archive ทุก 6 เดือน**
- Download Archive Sheet เป็น CSV
- เก็บสำรองไว้ใน Google Drive

### 3. **ตรวจสอบ Storage ทุกเดือน**
- รันฟังก์ชัน `getArchiveStats()`
- ดูว่าใกล้เต็มหรือยัง

### 4. **สร้าง Summary Sheet**
- สรุปค่าเฉลี่ยรายวัน
- ใช้สำหรับวิเคราะห์แนวโน้มระยะยาว

---

## 🎉 สรุป

ระบบ Auto Archive ให้คุณ:

✅ **เก็บข้อมูลไม่จำกัดเวลา** - ประวัติทั้งหมดอยู่ใน Archive  
✅ **Dashboard เร็วเสมอ** - ดึงแค่ 30 วันล่าสุด  
✅ **ทำงานอัตโนมัติ** - ไม่ต้องจัดการเอง  
✅ **รายงานทุกวัน** - รู้สถานะตลอดเวลา  
✅ **ปลอดภัย** - ข้อมูลไม่หาย มีสำรอง  

**ไม่ต้องกังวลเรื่องข้อมูลเต็มอีกต่อไป!** 🚀
